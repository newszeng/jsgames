var N=Object.defineProperty;var q=e=>{throw TypeError(e)};var D=(e,t,s)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var c=(e,t,s)=>D(e,typeof t!="symbol"?t+"":t,s),v=(e,t,s)=>t.has(e)||q("Cannot "+s);var x=(e,t,s)=>t.has(e)?q("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s);var S=(e,t,s)=>(v(e,t,"access private method"),s);class E extends Error{constructor(s,o,r){const n=s.status||s.status===0?s.status:"",i=s.statusText??"",u=`${n} ${i}`.trim(),l=u?`status code ${u}`:"an unknown error";super(`Request failed with ${l}: ${o.method} ${o.url}`);c(this,"response");c(this,"request");c(this,"options");this.name="HTTPError",this.response=s,this.request=o,this.options=r}}class C extends Error{constructor(s){super(`Request timed out: ${s.method} ${s.url}`);c(this,"request");this.name="TimeoutError",this.request=s}}const k=(()=>{let e=!1,t=!1;const s=typeof globalThis.ReadableStream=="function",o=typeof globalThis.Request=="function";if(s&&o)try{t=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type")}catch(r){if(r instanceof Error&&r.message==="unsupported BodyInit type")return!1;throw r}return e&&!t})(),H=typeof globalThis.AbortController=="function",B=typeof globalThis.AbortSignal=="function"&&typeof globalThis.AbortSignal.any=="function",M=typeof globalThis.ReadableStream=="function",$=typeof globalThis.FormData=="function",P=["get","post","put","patch","head","delete"],J={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*",bytes:"*/*"},w=2147483647,z=new TextEncoder().encode("------WebKitFormBoundaryaxpyiPgbbPti10Rw").length,U=Symbol("stop"),F={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,onUploadProgress:!0,fetch:!0},V={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},W=e=>{if(!e)return 0;if(e instanceof FormData){let t=0;for(const[s,o]of e)t+=z,t+=new TextEncoder().encode(`Content-Disposition: form-data; name="${s}"`).length,t+=typeof o=="string"?new TextEncoder().encode(o).length:o.size;return t}if(e instanceof Blob)return e.size;if(e instanceof ArrayBuffer)return e.byteLength;if(typeof e=="string")return new TextEncoder().encode(e).length;if(e instanceof URLSearchParams)return new TextEncoder().encode(e.toString()).length;if("byteLength"in e)return e.byteLength;if(typeof e=="object"&&e!==null)try{const t=JSON.stringify(e);return new TextEncoder().encode(t).length}catch{return 0}return 0},O=(e,t,s)=>{let o,r=0;return e.pipeThrough(new TransformStream({transform(n,i){if(i.enqueue(n),o){r+=o.byteLength;let u=t===0?0:r/t;u>=1&&(u=1-Number.EPSILON),s==null||s({percent:u,totalBytes:Math.max(t,r),transferredBytes:r},o)}o=n},flush(){o&&(r+=o.byteLength,s==null||s({percent:1,totalBytes:Math.max(t,r),transferredBytes:r},o))}}))},X=(e,t)=>{if(!e.body)return e;if(e.status===204)return new Response(null,{status:e.status,statusText:e.statusText,headers:e.headers});const s=Number(e.headers.get("content-length"))||0;return new Response(O(e.body,s,t),{status:e.status,statusText:e.statusText,headers:e.headers})},Y=(e,t,s)=>{if(!e.body)return e;const o=W(s??e.body);return new Request(e,{duplex:"half",body:O(e.body,o,t)})},d=e=>e!==null&&typeof e=="object",m=(...e)=>{for(const t of e)if((!d(t)||Array.isArray(t))&&t!==void 0)throw new TypeError("The `options` argument must be an object");return T({},...e)},j=(e={},t={})=>{const s=new globalThis.Headers(e),o=t instanceof globalThis.Headers,r=new globalThis.Headers(t);for(const[n,i]of r.entries())o&&i==="undefined"||i===void 0?s.delete(n):s.set(n,i);return s};function b(e,t,s){return Object.hasOwn(t,s)&&t[s]===void 0?[]:T(e[s]??[],t[s]??[])}const L=(e={},t={})=>({beforeRequest:b(e,t,"beforeRequest"),beforeRetry:b(e,t,"beforeRetry"),afterResponse:b(e,t,"afterResponse"),beforeError:b(e,t,"beforeError")}),T=(...e)=>{let t={},s={},o={};for(const r of e)if(Array.isArray(r))Array.isArray(t)||(t=[]),t=[...t,...r];else if(d(r)){for(let[n,i]of Object.entries(r))d(i)&&n in t&&(i=T(t[n],i)),t={...t,[n]:i};d(r.hooks)&&(o=L(o,r.hooks),t.hooks=o),d(r.headers)&&(s=j(s,r.headers),t.headers=s)}return t},G=e=>P.includes(e)?e.toUpperCase():e,K=["get","put","head","delete","options","trace"],Q=[408,413,429,500,502,503,504],Z=[413,429,503],A={limit:2,methods:K,statusCodes:Q,afterStatusCodes:Z,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:e=>.3*2**(e-1)*1e3},tt=(e={})=>{if(typeof e=="number")return{...A,limit:e};if(e.methods&&!Array.isArray(e.methods))throw new Error("retry.methods must be an array");if(e.statusCodes&&!Array.isArray(e.statusCodes))throw new Error("retry.statusCodes must be an array");return{...A,...e}};async function et(e,t,s,o){return new Promise((r,n)=>{const i=setTimeout(()=>{s&&s.abort(),n(new C(e))},o.timeout);o.fetch(e,t).then(r).catch(n).then(()=>{clearTimeout(i)})})}async function st(e,{signal:t}){return new Promise((s,o)=>{t&&(t.throwIfAborted(),t.addEventListener("abort",r,{once:!0}));function r(){clearTimeout(n),o(t.reason)}const n=setTimeout(()=>{t==null||t.removeEventListener("abort",r),s()},e)})}const ot=(e,t)=>{const s={};for(const o in t)!(o in V)&&!(o in F)&&!(o in e)&&(s[o]=t[o]);return s},rt=e=>e===void 0?!1:Array.isArray(e)?e.length>0:e instanceof URLSearchParams?e.size>0:typeof e=="object"?Object.keys(e).length>0:typeof e=="string"?e.trim().length>0:!!e;var g,I;const y=class y{constructor(t,s={}){c(this,"request");c(this,"abortController");c(this,"_retryCount",0);c(this,"_input");c(this,"_options");c(this,"_originalRequest");var o,r,n;if(this._input=t,this._options={...s,headers:j(this._input.headers,s.headers),hooks:L({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},s.hooks),method:G(s.method??this._input.method??"GET"),prefixUrl:String(s.prefixUrl||""),retry:tt(s.retry),throwHttpErrors:s.throwHttpErrors!==!1,timeout:s.timeout??1e4,fetch:s.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(H&&B){const i=this._options.signal??this._input.signal;this.abortController=new globalThis.AbortController,this._options.signal=i?AbortSignal.any([i,this.abortController.signal]):this.abortController.signal}if(k&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=((r=(o=this._options).stringifyJson)==null?void 0:r.call(o,this._options.json))??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),rt(this._options.searchParams)){const u="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(S(n=y,g,I).call(n,this._options.searchParams)).toString()),l=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,u);($&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(l,{...this.request}),this._options)}if(this._options.onUploadProgress){if(typeof this._options.onUploadProgress!="function")throw new TypeError("The `onUploadProgress` option must be a function");if(!k)throw new Error("Request streams are not supported in your environment. The `duplex` option for `Request` is not available.");this.request.body&&(this.request=Y(this.request,this._options.onUploadProgress,this._options.body))}}static create(t,s){var u,l;const o=new y(t,s),r=async()=>{if(typeof o._options.timeout=="number"&&o._options.timeout>w)throw new RangeError(`The \`timeout\` option cannot be greater than ${w}`);await Promise.resolve();let a=await o._fetch();for(const h of o._options.hooks.afterResponse){const f=await h(o.request,o._options,o._decorateResponse(a.clone()));f instanceof globalThis.Response&&(a=f)}if(o._decorateResponse(a),!a.ok&&o._options.throwHttpErrors){let h=new E(a,o.request,o._options);for(const f of o._options.hooks.beforeError)h=await f(h);throw h}if(o._options.onDownloadProgress){if(typeof o._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!M)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return X(a.clone(),o._options.onDownloadProgress)}return a},i=(o._options.retry.methods.includes(o.request.method.toLowerCase())?o._retry(r):r()).finally(async()=>{var f,p;const a=o._originalRequest,h=[];a&&!a.bodyUsed&&h.push((f=a.body)==null?void 0:f.cancel()),o.request.bodyUsed||h.push((p=o.request.body)==null?void 0:p.cancel()),await Promise.all(h)});for(const[a,h]of Object.entries(J))a==="bytes"&&typeof((l=(u=globalThis.Response)==null?void 0:u.prototype)==null?void 0:l.bytes)!="function"||(i[a]=async()=>{o.request.headers.set("accept",o.request.headers.get("accept")||h);const f=await i;if(a==="json"){if(f.status===204)return"";const p=await f.text();return p===""?"":s.parseJson?s.parseJson(p):JSON.parse(p)}return f[a]()});return i}_calculateRetryDelay(t){if(this._retryCount++,this._retryCount>this._options.retry.limit||t instanceof C)throw t;if(t instanceof E){if(!this._options.retry.statusCodes.includes(t.response.status))throw t;const o=t.response.headers.get("Retry-After")??t.response.headers.get("RateLimit-Reset")??t.response.headers.get("X-RateLimit-Reset")??t.response.headers.get("X-Rate-Limit-Reset");if(o&&this._options.retry.afterStatusCodes.includes(t.response.status)){let r=Number(o)*1e3;Number.isNaN(r)?r=Date.parse(o)-Date.now():r>=Date.parse("2024-01-01")&&(r-=Date.now());const n=this._options.retry.maxRetryAfter??r;return r<n?r:n}if(t.response.status===413)throw t}const s=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,s)}_decorateResponse(t){return this._options.parseJson&&(t.json=async()=>this._options.parseJson(await t.text())),t}async _retry(t){try{return await t()}catch(s){const o=Math.min(this._calculateRetryDelay(s),w);if(this._retryCount<1)throw s;await st(o,{signal:this._options.signal});for(const r of this._options.hooks.beforeRetry)if(await r({request:this.request,options:this._options,error:s,retryCount:this._retryCount})===U)return;return this._retry(t)}}async _fetch(){for(const s of this._options.hooks.beforeRequest){const o=await s(this.request,this._options);if(o instanceof Request){this.request=o;break}if(o instanceof Response)return o}const t=ot(this.request,this._options);return this._originalRequest=this.request,this.request=this._originalRequest.clone(),this._options.timeout===!1?this._options.fetch(this._originalRequest,t):et(this._originalRequest,t,this.abortController,this._options)}};g=new WeakSet,I=function(t){return t&&typeof t=="object"&&!Array.isArray(t)&&!(t instanceof URLSearchParams)?Object.fromEntries(Object.entries(t).filter(([,s])=>s!==void 0)):t},x(y,g);let _=y;/*! MIT License Â© Sindre Sorhus */const R=e=>{const t=(s,o)=>_.create(s,m(e,o));for(const s of P)t[s]=(o,r)=>_.create(o,m(e,r,{method:s}));return t.create=s=>R(m(s)),t.extend=s=>(typeof s=="function"&&(s=s(e??{})),R(m(e,s))),t.stop=U,t},it=R();export{it as k};
